<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM系统 - 客户管理</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <div id="app" class="app-container">
        <!-- 顶部导航栏 -->
        <header class="header">
            <div class="logo">CRM系统</div>
            <div class="user-info">
                <span class="nickname">{{ userInfo.nickname || '--' }}</span>
                <button class="btn btn-secondary" @click="logout">退出登录</button>
            </div>
        </header>

        <!-- 主体内容区 -->
        <div class="main-content">
            <!-- 左侧菜单 -->
            <aside class="sidebar">
                <ul class="menu">
                    <li class="menu-item" :class="{ active: currentModule === 'customer' }" @click="switchModule('customer')">
                        <a href="#">客户管理</a>
                    </li>
                    <li class="menu-item" :class="{ active: currentModule === 'followup' }" @click="switchModule('followup')">
                        <a href="#">跟进记录</a>
                    </li>
                    <li class="menu-item" :class="{ active: currentModule === 'statistics' }" @click="switchModule('statistics')">
                        <a href="#">数据统计</a>
                    </li>
                    <li class="menu-item" :class="{ active: currentModule === 'userManagement' }" @click="switchModule('userManagement')">
                        <a href="#">用户管理</a>
                    </li>
                    <li class="menu-item" :class="{ active: currentModule === 'userInfo' }" @click="switchModule('userInfo')">
                        <a href="#">个人信息</a>
                    </li>
                </ul>
            </aside>

            <!-- 右侧内容区 -->
            <main class="content">
                <!-- 客户管理模块 -->
                <div v-if="currentModule === 'customer'" class="module-content">
                    <div class="content-header">
                        <h2>客户管理</h2>
                        <div class="btn-group">
                            <button class="btn btn-primary" @click="openCustomerModal()">添加客户</button>
                            <button class="btn btn-success" @click="exportCustomers()">导出Excel</button>
                        </div>
                    </div>

                    <!-- 筛选栏 -->
                    <div class="filter-bar">
                        <div class="form-group">
                            <label for="filterName">姓名</label>
                            <input type="text" v-model="customerFilters.name" placeholder="请输入姓名">
                        </div>
                        <div class="form-group">
                            <label for="filterPhone">手机号</label>
                            <input type="text" v-model="customerFilters.phone" placeholder="请输入手机号">
                        </div>
                        <div class="form-group">
                            <label for="filterSource">来源</label>
                            <select v-model="customerFilters.source">
                                <option value="">全部</option>
                                <option value="网络">网络</option>
                                <option value="推荐">推荐</option>
                                <option value="线下">线下</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" @click="loadCustomers(1)">查询</button>
                    </div>

                    <!-- 客户列表 -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>姓名</th>
                                    <th>手机号</th>
                                    <th>邮箱</th>
                                    <th>公司</th>
                                    <th>职位</th>
                                    <th>来源</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="customers.length === 0">
                                    <td colspan="9" style="text-align: center;">{{ loading ? '加载中...' : '暂无客户数据' }}</td>
                                </tr>
                                <tr v-for="customer in customers" :key="customer.id">
                                    <td>{{ customer.id }}</td>
                                    <td>{{ customer.name }}</td>
                                    <td>{{ customer.phone }}</td>
                                    <td>{{ customer.email || '-' }}</td>
                                    <td>{{ customer.company || '-' }}</td>
                                    <td>{{ customer.position || '-' }}</td>
                                    <td>{{ customer.source || '-' }}</td>
                                    <td>{{ customer.created_at }}</td>
                                    <td>
                                        <button class="btn btn-secondary" @click="editCustomer(customer.id)">编辑</button>
                                        <button class="btn btn-danger" @click="deleteCustomer(customer.id)">删除</button>
                                        <button class="btn btn-success" @click="viewCustomerFollowups(customer.id)">跟进记录</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- 分页 -->
                        <div class="pagination" v-if="customerTotal > 10">
                            <button class="btn btn-secondary" @click="loadCustomers(customerPage - 1)" :disabled="customerPage === 1">上一页</button>
                            <span v-for="page in Math.ceil(customerTotal / 10)" :key="page" class="page-item" :class="{ active: page === customerPage }">
                                <button class="btn" @click="loadCustomers(page)">{{ page }}</button>
                            </span>
                            <button class="btn btn-secondary" @click="loadCustomers(customerPage + 1)" :disabled="customerPage >= Math.ceil(customerTotal / 10)">下一页</button>
                        </div>
                    </div>
                </div>

                <!-- 跟进记录模块 -->
                <div v-if="currentModule === 'followup'" class="module-content">
                    <div class="content-header">
                        <h2>跟进记录</h2>
                        <button class="btn btn-primary" @click="openFollowupModal()">添加跟进记录</button>
                    </div>

                    <!-- 筛选栏 -->
                    <div class="filter-bar">
                        <div class="form-group">
                            <label for="filterCustomer">客户</label>
                            <select v-model="followupFilters.customerId">
                                <option value="">全部客户</option>
                                <option v-for="customer in customers" :key="customer.id" :value="customer.id">{{ customer.name }} ({{ customer.phone }})</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" @click="loadFollowups(1)">查询</button>
                    </div>

                    <!-- 跟进记录列表 -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>客户</th>
                                    <th>跟进时间</th>
                                    <th>跟进方式</th>
                                    <th>跟进内容</th>
                                    <th>下次提醒</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="followups.length === 0">
                                    <td colspan="7" style="text-align: center;">{{ loading ? '加载中...' : '暂无跟进记录' }}</td>
                                </tr>
                                <tr v-for="followup in followups" :key="followup.id">
                                    <td>{{ followup.id }}</td>
                                    <td>{{ getCustomerName(followup.customer_id) }}</td>
                                    <td>{{ followup.follow_time }}</td>
                                    <td>{{ followup.follow_method }}</td>
                                    <td>{{ followup.content.substring(0, 50) }}{{ followup.content.length > 50 ? '...' : '' }}</td>
                                    <td>{{ followup.next_follow_reminder || '-' }}</td>
                                    <td>
                                        <button class="btn btn-danger" @click="deleteFollowup(followup.id)">删除</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- 分页 -->
                        <div class="pagination" v-if="followupTotal > 10">
                            <button class="btn btn-secondary" @click="loadFollowups(followupPage - 1)" :disabled="followupPage === 1">上一页</button>
                            <span v-for="page in Math.ceil(followupTotal / 10)" :key="page" class="page-item" :class="{ active: page === followupPage }">
                                <button class="btn" @click="loadFollowups(page)">{{ page }}</button>
                            </span>
                            <button class="btn btn-secondary" @click="loadFollowups(followupPage + 1)" :disabled="followupPage >= Math.ceil(followupTotal / 10)">下一页</button>
                        </div>
                    </div>
                </div>

                <!-- 数据统计模块 -->
                <div v-if="currentModule === 'statistics'" class="module-content">
                    <div class="content-header">
                        <h2>数据统计</h2>
                    </div>

                    <!-- 筛选栏 -->
                    <div class="filter-bar">
                        <div class="form-group">
                            <label for="statisticsDays">统计天数</label>
                            <select v-model="statisticsDays" @change="loadStatistics">
                                <option value="7">最近7天</option>
                                <option value="30">最近30天</option>
                                <option value="90">最近90天</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" @click="loadStatistics">刷新数据</button>
                    </div>

                    <!-- 统计图表 -->
                    <div class="statistics-charts">
                        <div class="chart-row">
                            <div class="chart-card">
                                <h3>客户来源分布</h3>
                                <div ref="customerSourceChart" class="chart"></div>
                            </div>
                            <div class="chart-card">
                                <h3>跟进方式分布</h3>
                                <div ref="followupMethodChart" class="chart"></div>
                            </div>
                        </div>
                        <div class="chart-row">
                            <div class="chart-card">
                                <h3>客户数量趋势</h3>
                                <div ref="customerCountChart" class="chart"></div>
                            </div>
                            <div class="chart-card">
                                <h3>跟进记录趋势</h3>
                                <div ref="followupCountChart" class="chart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户管理模块 -->
                <div v-if="currentModule === 'userManagement'" class="module-content">
                    <div class="content-header">
                        <h2>用户管理</h2>
                        <button class="btn btn-primary" @click="openUserModal()">添加用户</button>
                    </div>

                    <!-- 用户列表 -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>昵称</th>
                                    <th>角色</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="users.length === 0">
                                    <td colspan="6" style="text-align: center;">{{ loading ? '加载中...' : '暂无用户数据' }}</td>
                                </tr>
                                <tr v-for="user in users" :key="user.id">
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.nickname }}</td>
                                    <td>{{ user.role === 'admin' ? '管理员' : '普通用户' }}</td>
                                    <td>{{ user.created_at }}</td>
                                    <td>
                                        <button class="btn btn-secondary" @click="editUser(user.id)">编辑</button>
                                        <button class="btn btn-danger" @click="deleteUser(user.id)" :disabled="user.id === userInfo.id">删除</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 个人信息模块 -->
                <div v-if="currentModule === 'userInfo'" class="module-content">
                    <div class="content-header">
                        <h2>个人信息</h2>
                    </div>

                    <div class="card">
                        <form @submit.prevent="updateUserInfo">
                            <div class="form-group">
                                <label for="userUsername">用户名</label>
                                <input type="text" v-model="userForm.username" disabled>
                            </div>
                            <div class="form-group">
                                <label for="userNickname">昵称</label>
                                <input type="text" v-model="userForm.nickname" required>
                            </div>
                            <div class="form-group">
                                <label for="userPassword">密码</label>
                                <input type="password" v-model="userForm.password" placeholder="留空则不修改">
                            </div>
                            <div class="form-group">
                                <label for="userRole">角色</label>
                                <input type="text" v-model="userForm.role" disabled>
                            </div>
                            <button type="submit" class="btn btn-primary">保存修改</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加/编辑客户模态框 -->
    <div class="modal" v-if="showCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>{{ editingCustomer ? '编辑客户' : '添加客户' }}</h3>
                <button class="close" @click="showCustomerModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="saveCustomer">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">姓名</label>
                            <input type="text" v-model="customerForm.name" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">手机号</label>
                            <input type="text" v-model="customerForm.phone" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerEmail">邮箱</label>
                            <input type="email" v-model="customerForm.email">
                        </div>
                        <div class="form-group">
                            <label for="customerCompany">公司</label>
                            <input type="text" v-model="customerForm.company">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerPosition">职位</label>
                            <input type="text" v-model="customerForm.position">
                        </div>
                        <div class="form-group">
                            <label for="customerSource">来源</label>
                            <select v-model="customerForm.source">
                                <option value="网络">网络</option>
                                <option value="推荐">推荐</option>
                                <option value="线下">线下</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerNotes">备注</label>
                        <textarea v-model="customerForm.notes" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="showCustomerModal = false">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加跟进记录模态框 -->
    <div class="modal" v-if="showFollowupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加跟进记录</h3>
                <button class="close" @click="showFollowupModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="saveFollowup">
                    <div class="form-group">
                        <label for="followupCustomer">客户</label>
                        <select v-model="followupForm.customer_id" required>
                            <option value="">请选择客户</option>
                            <option v-for="customer in customers" :key="customer.id" :value="customer.id">{{ customer.name }} ({{ customer.phone }})</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="followupTime">跟进时间</label>
                        <input type="datetime-local" v-model="followupForm.follow_time" required>
                    </div>
                    <div class="form-group">
                        <label for="followupMethod">跟进方式</label>
                        <select v-model="followupForm.follow_method" required>
                            <option value="电话">电话</option>
                            <option value="微信">微信</option>
                            <option value="面谈">面谈</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="followupContent">跟进内容</label>
                        <textarea v-model="followupForm.content" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="followupNext">下次跟进提醒</label>
                        <input type="datetime-local" v-model="followupForm.next_follow_reminder">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="showFollowupModal = false">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加/编辑用户模态框 -->
    <div class="modal" v-if="showUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>{{ editingUser ? '编辑用户' : '添加用户' }}</h3>
                <button class="close" @click="showUserModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="saveUser">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userUsername">用户名</label>
                            <input type="text" v-model="userModalForm.username" :disabled="editingUser" required>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">密码</label>
                            <input type="password" v-model="userModalForm.password" :required="!editingUser" placeholder="留空则不修改">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userNickname">昵称</label>
                            <input type="text" v-model="userModalForm.nickname" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">角色</label>
                            <select v-model="userModalForm.role" required>
                                <option value="admin">管理员</option>
                                <option value="user">普通用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="showUserModal = false">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                // 用户信息
                userInfo: {},
                // 当前模块
                currentModule: 'customer',
                // 加载状态
                loading: false,
                // 客户管理
                customers: [],
                customerPage: 1,
                customerTotal: 0,
                customerFilters: {
                    name: '',
                    phone: '',
                    source: ''
                },
                showCustomerModal: false,
                editingCustomer: false,
                customerForm: {
                    id: '',
                    name: '',
                    phone: '',
                    email: '',
                    company: '',
                    position: '',
                    source: '网络',
                    notes: ''
                },
                // 跟进记录
                followups: [],
                followupPage: 1,
                followupTotal: 0,
                followupFilters: {
                    customerId: ''
                },
                showFollowupModal: false,
                followupForm: {
                    customer_id: '',
                    follow_time: new Date().toISOString().slice(0, 16),
                    follow_method: '电话',
                    content: '',
                    next_follow_reminder: ''
                },
                // 数据统计
                statisticsDays: 7,
                charts: {},
                // 用户管理
                users: [],
                showUserModal: false,
                editingUser: false,
                userModalForm: {
                    id: '',
                    username: '',
                    password: '',
                    nickname: '',
                    role: 'user'
                },
                // 个人信息
                userForm: {
                    username: '',
                    nickname: '',
                    password: '',
                    role: ''
                }
            },
            mounted() {
                // 检查登录状态
                this.checkLoginStatus();
                // 加载用户信息
                this.loadUserInfo();
                // 加载客户列表
                this.loadCustomers();
            },
            methods: {
                // 检查登录状态
                checkLoginStatus() {
                    const userInfo = localStorage.getItem('userInfo');
                    if (!userInfo) {
                        // 未登录，跳转到登录页
                        window.location.href = 'login.html';
                    } else {
                        this.userInfo = JSON.parse(userInfo);
                    }
                },
                // 加载用户信息
                loadUserInfo() {
                    fetch('/api/user/info')
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.userInfo = data.data;
                                localStorage.setItem('userInfo', JSON.stringify(data.data));
                                // 初始化个人信息表单
                                this.userForm = {
                                    username: data.data.username,
                                    nickname: data.data.nickname,
                                    password: '',
                                    role: data.data.role
                                };
                            }
                        })
                        .catch(error => {
                            console.error('加载用户信息失败:', error);
                        });
                },
                // 退出登录
                logout() {
                    fetch('/api/logout', { method: 'POST' })
                        .then(() => {
                            // 清除本地存储
                            localStorage.removeItem('userInfo');
                            // 跳转到登录页
                            window.location.href = 'login.html';
                        });
                },
                // 切换模块
                switchModule(module) {
                    this.currentModule = module;
                    
                    // 加载对应模块数据
                    if (module === 'customer') {
                        this.loadCustomers();
                    } else if (module === 'followup') {
                        this.loadFollowups();
                    } else if (module === 'statistics') {
                        this.$nextTick(() => {
                            this.loadStatistics();
                        });
                    } else if (module === 'userManagement') {
                        this.loadUsers();
                    }
                },
                // 加载客户列表
                loadCustomers(page = 1) {
                    this.customerPage = page;
                    this.loading = true;
                    
                    const { name, phone, source } = this.customerFilters;
                    
                    fetch(`/api/customers?page=${page}&limit=10&name=${name}&phone=${phone}&source=${source}`)
                        .then(response => response.json())
                        .then(data => {
                            this.loading = false;
                            if (data.code === 200) {
                                this.customers = data.data;
                                this.customerTotal = data.total;
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            this.loading = false;
                            console.error('加载客户失败:', error);
                            alert('加载客户失败，请检查网络连接');
                        });
                },
                // 打开客户模态框
                openCustomerModal() {
                    this.editingCustomer = false;
                    this.customerForm = {
                        id: '',
                        name: '',
                        phone: '',
                        email: '',
                        company: '',
                        position: '',
                        source: '网络',
                        notes: ''
                    };
                    this.showCustomerModal = true;
                },
                // 编辑客户
                editCustomer(id) {
                    fetch(`/api/customers/${id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.editingCustomer = true;
                                this.customerForm = {
                                    id: data.data.id,
                                    name: data.data.name,
                                    phone: data.data.phone,
                                    email: data.data.email || '',
                                    company: data.data.company || '',
                                    position: data.data.position || '',
                                    source: data.data.source || '网络',
                                    notes: data.data.notes || ''
                                };
                                this.showCustomerModal = true;
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('获取客户详情失败:', error);
                            alert('获取客户详情失败，请检查网络连接');
                        });
                },
                // 保存客户
                saveCustomer() {
                    const { id, name, phone, email, company, position, source, notes } = this.customerForm;
                    const url = id ? `/api/customers/${id}` : '/api/customers';
                    const method = id ? 'PUT' : 'POST';
                    
                    fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, phone, email, company, position, source, notes })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            alert('保存成功');
                            this.showCustomerModal = false;
                            this.loadCustomers();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存客户失败:', error);
                        alert('保存客户失败，请检查网络连接');
                    });
                },
                // 删除客户
                deleteCustomer(id) {
                    if (confirm('确定要删除这个客户吗？删除后相关的跟进记录也会被删除')) {
                        fetch(`/api/customers/${id}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.code === 200) {
                                    alert('删除成功');
                                    this.loadCustomers();
                                } else {
                                    alert(data.message);
                                }
                            })
                            .catch(error => {
                                console.error('删除客户失败:', error);
                                alert('删除客户失败，请检查网络连接');
                            });
                    }
                },
                // 查看客户跟进记录
                viewCustomerFollowups(customerId) {
                    this.currentModule = 'followup';
                    this.followupFilters.customerId = customerId;
                    this.loadFollowups();
                },
                // 加载跟进记录
                loadFollowups(page = 1) {
                    this.followupPage = page;
                    this.loading = true;
                    
                    const customerId = this.followupFilters.customerId;
                    
                    fetch(`/api/followups?page=${page}&limit=10&customer_id=${customerId}`)
                        .then(response => response.json())
                        .then(data => {
                            this.loading = false;
                            if (data.code === 200) {
                                this.followups = data.data;
                                this.followupTotal = data.total;
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            this.loading = false;
                            console.error('加载跟进记录失败:', error);
                            alert('加载跟进记录失败，请检查网络连接');
                        });
                },
                // 打开跟进记录模态框
                openFollowupModal() {
                    this.followupForm = {
                        customer_id: '',
                        follow_time: new Date().toISOString().slice(0, 16),
                        follow_method: '电话',
                        content: '',
                        next_follow_reminder: ''
                    };
                    this.showFollowupModal = true;
                },
                // 保存跟进记录
                saveFollowup() {
                    fetch('/api/followups', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.followupForm)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            alert('保存成功');
                            this.showFollowupModal = false;
                            this.loadFollowups();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存跟进记录失败:', error);
                        alert('保存跟进记录失败，请检查网络连接');
                    });
                },
                // 删除跟进记录
                deleteFollowup(id) {
                    if (confirm('确定要删除这条跟进记录吗？')) {
                        fetch(`/api/followups/${id}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.code === 200) {
                                    alert('删除成功');
                                    this.loadFollowups();
                                } else {
                                    alert(data.message);
                                }
                            })
                            .catch(error => {
                                console.error('删除跟进记录失败:', error);
                                alert('删除跟进记录失败，请检查网络连接');
                            });
                    }
                },
                // 获取客户名称
                getCustomerName(customerId) {
                    const customer = this.customers.find(c => c.id === customerId);
                    return customer ? customer.name : '未知客户';
                },
                // 导出客户列表
                exportCustomers() {
                    const { name, phone, source } = this.customerFilters;
                    
                    // 构建导出URL
                    let url = `/api/customers/export?`;
                    if (name) url += `name=${name}&`;
                    if (phone) url += `phone=${phone}&`;
                    if (source) url += `source=${source}&`;
                    
                    // 移除最后一个&符号
                    url = url.replace(/&$/, '');
                    
                    // 打开新窗口下载
                    window.open(url, '_blank');
                },
                // 加载统计数据
                loadStatistics() {
                    const days = this.statisticsDays;
                    
                    // 加载客户来源分布
                    this.loadCustomerSourceStatistics();
                    // 加载跟进方式分布
                    this.loadFollowupMethodStatistics();
                    // 加载客户数量趋势
                    this.loadCustomerCountStatistics(days);
                    // 加载跟进记录趋势
                    this.loadFollowupCountStatistics(days);
                },
                // 加载客户来源分布统计
                loadCustomerSourceStatistics() {
                    fetch('/api/statistics/customer/source')
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.$nextTick(() => {
                                    this.renderCustomerSourceChart(data.data);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取客户来源分布失败:', error);
                        });
                },
                // 加载跟进方式分布统计
                loadFollowupMethodStatistics() {
                    fetch('/api/statistics/followup/method')
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.$nextTick(() => {
                                    this.renderFollowupMethodChart(data.data);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取跟进方式分布失败:', error);
                        });
                },
                // 加载客户数量趋势统计
                loadCustomerCountStatistics(days) {
                    fetch(`/api/statistics/customer/count?days=${days}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.$nextTick(() => {
                                    this.renderCustomerCountChart(data.data);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取客户数量趋势失败:', error);
                        });
                },
                // 加载跟进记录趋势统计
                loadFollowupCountStatistics(days) {
                    fetch(`/api/statistics/followup/count?days=${days}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.$nextTick(() => {
                                    this.renderFollowupCountChart(data.data);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('获取跟进记录趋势失败:', error);
                        });
                },
                // 渲染客户来源分布图表
                renderCustomerSourceChart(data) {
                    if (!this.$refs.customerSourceChart) return;
                    
                    const chart = echarts.init(this.$refs.customerSourceChart);
                    const option = {
                        tooltip: {
                            trigger: 'item'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [
                            {
                                name: '客户来源',
                                type: 'pie',
                                radius: '50%',
                                data: Object.entries(data).map(([name, value]) => ({ name, value })),
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }
                        ]
                    };
                    chart.setOption(option);
                    
                    // 窗口大小变化时重新调整图表大小
                    window.addEventListener('resize', () => {
                        chart.resize();
                    });
                },
                // 渲染跟进方式分布图表
                renderFollowupMethodChart(data) {
                    if (!this.$refs.followupMethodChart) return;
                    
                    const chart = echarts.init(this.$refs.followupMethodChart);
                    const option = {
                        tooltip: {
                            trigger: 'item'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [
                            {
                                name: '跟进方式',
                                type: 'pie',
                                radius: '50%',
                                data: Object.entries(data).map(([name, value]) => ({ name, value })),
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }
                        ]
                    };
                    chart.setOption(option);
                    
                    // 窗口大小变化时重新调整图表大小
                    window.addEventListener('resize', () => {
                        chart.resize();
                    });
                },
                // 渲染客户数量趋势图表
                renderCustomerCountChart(data) {
                    if (!this.$refs.customerCountChart) return;
                    
                    const chart = echarts.init(this.$refs.customerCountChart);
                    const dates = Object.keys(data);
                    const counts = Object.values(data);
                    
                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: dates
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [
                            {
                                data: counts,
                                type: 'line',
                                smooth: true
                            }
                        ]
                    };
                    chart.setOption(option);
                    
                    // 窗口大小变化时重新调整图表大小
                    window.addEventListener('resize', () => {
                        chart.resize();
                    });
                },
                // 渲染跟进记录趋势图表
                renderFollowupCountChart(data) {
                    if (!this.$refs.followupCountChart) return;
                    
                    const chart = echarts.init(this.$refs.followupCountChart);
                    const dates = Object.keys(data);
                    const counts = Object.values(data);
                    
                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: dates
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [
                            {
                                data: counts,
                                type: 'line',
                                smooth: true
                            }
                        ]
                    };
                    chart.setOption(option);
                    
                    // 窗口大小变化时重新调整图表大小
                    window.addEventListener('resize', () => {
                        chart.resize();
                    });
                },
                // 加载用户列表
                loadUsers() {
                    this.loading = true;
                    
                    fetch('/api/users')
                        .then(response => response.json())
                        .then(data => {
                            this.loading = false;
                            if (data.code === 200) {
                                this.users = data.data;
                            } else if (data.code === 403) {
                                alert('权限不足，仅管理员可访问');
                                // 切换回个人信息模块
                                this.currentModule = 'userInfo';
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            this.loading = false;
                            console.error('加载用户列表失败:', error);
                            alert('加载用户列表失败，请检查网络连接');
                        });
                },
                // 打开用户模态框
                openUserModal() {
                    this.editingUser = false;
                    this.userModalForm = {
                        id: '',
                        username: '',
                        password: '',
                        nickname: '',
                        role: 'user'
                    };
                    this.showUserModal = true;
                },
                // 编辑用户
                editUser(id) {
                    fetch(`/api/users/${id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                this.editingUser = true;
                                this.userModalForm = {
                                    id: data.data.id,
                                    username: data.data.username,
                                    password: '',
                                    nickname: data.data.nickname,
                                    role: data.data.role
                                };
                                this.showUserModal = true;
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('获取用户详情失败:', error);
                            alert('获取用户详情失败，请检查网络连接');
                        });
                },
                // 保存用户
                saveUser() {
                    const { id, username, password, nickname, role } = this.userModalForm;
                    const url = id ? `/api/users/${id}` : '/api/users';
                    const method = id ? 'PUT' : 'POST';
                    
                    const data = {
                        username,
                        nickname,
                        role
                    };
                    
                    // 只有在添加用户或修改密码时才包含密码字段
                    if (password) {
                        data.password = password;
                    }
                    
                    fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            alert('保存成功');
                            this.showUserModal = false;
                            this.loadUsers();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存用户失败:', error);
                        alert('保存用户失败，请检查网络连接');
                    });
                },
                // 删除用户
                deleteUser(id) {
                    if (id === this.userInfo.id) {
                        alert('不能删除自己');
                        return;
                    }
                    
                    if (confirm('确定要删除这个用户吗？')) {
                        fetch(`/api/users/${id}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.code === 200) {
                                    alert('删除成功');
                                    this.loadUsers();
                                } else {
                                    alert(data.message);
                                }
                            })
                            .catch(error => {
                                console.error('删除用户失败:', error);
                                alert('删除用户失败，请检查网络连接');
                            });
                    }
                },
                // 更新个人信息
                updateUserInfo() {
                    fetch('/api/user/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.userForm)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            alert('保存成功');
                            // 更新本地存储的用户信息
                            this.userInfo.nickname = this.userForm.nickname;
                            localStorage.setItem('userInfo', JSON.stringify(this.userInfo));
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存个人信息失败:', error);
                        alert('保存个人信息失败，请检查网络连接');
                    });
                }
            }
        }
    </script>
</body>
</html>