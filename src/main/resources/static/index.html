<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM系统 - 客户管理</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航栏 -->
        <header class="header">
            <div class="logo">CRM系统</div>
            <div class="user-info">
                <span class="nickname" id="userNickname">--</span>
                <button class="btn btn-secondary" id="logoutBtn">退出登录</button>
            </div>
        </header>

        <!-- 主体内容区 -->
        <div class="main-content">
            <!-- 左侧菜单 -->
            <aside class="sidebar">
                <ul class="menu">
                    <li class="menu-item active" data-target="customer-module">
                        <a href="#">客户管理</a>
                    </li>
                    <li class="menu-item" data-target="followup-module">
                        <a href="#">跟进记录</a>
                    </li>
                    <li class="menu-item" data-target="statistics-module">
                        <a href="#">数据统计</a>
                    </li>
                    <li class="menu-item" data-target="user-module">
                        <a href="#">个人信息</a>
                    </li>
                </ul>
            </aside>

            <!-- 右侧内容区 -->
            <main class="content">
                <!-- 客户管理模块 -->
                <div id="customer-module" class="module-content">
                    <div class="content-header">
                        <h2>客户管理</h2>
                        <button class="btn btn-primary" id="addCustomerBtn">添加客户</button>
                    </div>

                    <!-- 筛选栏 -->
                    <div class="filter-bar">
                        <div class="form-group">
                            <label for="filterName">姓名</label>
                            <input type="text" id="filterName" placeholder="请输入姓名">
                        </div>
                        <div class="form-group">
                            <label for="filterPhone">手机号</label>
                            <input type="text" id="filterPhone" placeholder="请输入手机号">
                        </div>
                        <div class="form-group">
                            <label for="filterSource">来源</label>
                            <select id="filterSource">
                                <option value="">全部</option>
                                <option value="网络">网络</option>
                                <option value="推荐">推荐</option>
                                <option value="线下">线下</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="searchCustomerBtn">查询</button>
                        <button class="btn btn-success" id="exportCustomerBtn">导出Excel</button>
                    </div>

                    <!-- 客户列表 -->
                    <div class="card">
                        <table class="table" id="customerTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>姓名</th>
                                    <th>手机号</th>
                                    <th>邮箱</th>
                                    <th>公司</th>
                                    <th>职位</th>
                                    <th>来源</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 客户数据将通过JavaScript动态加载 -->
                                <tr><td colspan="9" style="text-align: center;">加载中...</td></tr>
                            </tbody>
                        </table>
                        
                        <!-- 分页 -->
                        <div class="pagination" id="customerPagination">
                            <!-- 分页按钮将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>

                <!-- 跟进记录模块 -->
                <div id="followup-module" class="module-content hidden">
                    <div class="content-header">
                        <h2>跟进记录</h2>
                        <button class="btn btn-primary" id="addFollowupBtn">添加跟进记录</button>
                    </div>

                    <!-- 筛选栏 -->
                    <div class="filter-bar">
                        <div class="form-group">
                            <label for="filterCustomer">客户</label>
                            <select id="filterCustomer">
                                <option value="">全部客户</option>
                                <!-- 客户选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <button class="btn btn-primary" id="searchFollowupBtn">查询</button>
                    </div>

                    <!-- 跟进记录列表 -->
                    <div class="card">
                        <table class="table" id="followupTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>客户</th>
                                    <th>跟进时间</th>
                                    <th>跟进方式</th>
                                    <th>跟进内容</th>
                                    <th>下次提醒</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 跟进记录数据将通过JavaScript动态加载 -->
                                <tr><td colspan="7" style="text-align: center;">加载中...</td></tr>
                            </tbody>
                        </table>
                        
                        <!-- 分页 -->
                        <div class="pagination" id="followupPagination">
                            <!-- 分页按钮将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>

                <!-- 个人信息模块 -->
                <div id="user-module" class="module-content hidden">
                    <div class="content-header">
                        <h2>个人信息</h2>
                    </div>

                    <div class="card">
                        <form id="userForm" class="form">
                            <div class="form-group">
                                <label for="userUsername">用户名</label>
                                <input type="text" id="userUsername" disabled>
                            </div>
                            <div class="form-group">
                                <label for="userNickname">昵称</label>
                                <input type="text" id="userNicknameInput" required>
                            </div>
                            <div class="form-group">
                                <label for="userPassword">密码</label>
                                <input type="password" id="userPassword" placeholder="留空则不修改">
                            </div>
                            <div class="form-group">
                                <label for="userRole">角色</label>
                                <input type="text" id="userRole" disabled>
                            </div>
                            <button type="submit" class="btn btn-primary">保存修改</button>
                        </form>
                    </div>
                </div>

                <!-- 数据统计模块 -->
                <div id="statistics-module" class="module-content hidden">
                    <div class="content-header">
                        <h2>数据统计</h2>
                    </div>

                    <!-- 统计筛选栏 -->
                    <div class="filter-bar">
                        <div class="form-group">
                            <label for="statisticsDays">统计天数</label>
                            <select id="statisticsDays">
                                <option value="7">最近7天</option>
                                <option value="30">最近30天</option>
                                <option value="90">最近90天</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="refreshStatisticsBtn">刷新数据</button>
                    </div>

                    <!-- 统计卡片 -->
                    <div class="statistics-cards">
                        <div class="card">
                            <h3>客户来源分布</h3>
                            <div id="customerSourceChart" style="height: 300px;"></div>
                        </div>
                        <div class="card">
                            <h3>跟进方式分布</h3>
                            <div id="followupMethodChart" style="height: 300px;"></div>
                        </div>
                    </div>

                    <div class="statistics-cards">
                        <div class="card">
                            <h3>客户数量趋势</h3>
                            <div id="customerCountChart" style="height: 300px;"></div>
                        </div>
                        <div class="card">
                            <h3>跟进记录趋势</h3>
                            <div id="followupCountChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加/编辑客户模态框 -->
    <div id="customerModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">添加客户</h3>
                <button class="close" id="closeCustomerModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customerForm" class="form">
                    <input type="hidden" id="customerId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">姓名</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">手机号</label>
                            <input type="text" id="customerPhone" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerEmail">邮箱</label>
                            <input type="email" id="customerEmail">
                        </div>
                        <div class="form-group">
                            <label for="customerCompany">公司</label>
                            <input type="text" id="customerCompany">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerPosition">职位</label>
                            <input type="text" id="customerPosition">
                        </div>
                        <div class="form-group">
                            <label for="customerSource">来源</label>
                            <select id="customerSource">
                                <option value="网络">网络</option>
                                <option value="推荐">推荐</option>
                                <option value="线下">线下</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerNotes">备注</label>
                        <textarea id="customerNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCustomerBtn">取消</button>
                <button class="btn btn-primary" id="saveCustomerBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加跟进记录模态框 -->
    <div id="followupModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加跟进记录</h3>
                <button class="close" id="closeFollowupModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="followupForm" class="form">
                    <div class="form-group">
                        <label for="followupCustomer">客户</label>
                        <select id="followupCustomer" required>
                            <option value="">请选择客户</option>
                            <!-- 客户选项将通过JavaScript动态加载 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="followupTime">跟进时间</label>
                        <input type="datetime-local" id="followupTime" required>
                    </div>
                    <div class="form-group">
                        <label for="followupMethod">跟进方式</label>
                        <select id="followupMethod" required>
                            <option value="电话">电话</option>
                            <option value="微信">微信</option>
                            <option value="面谈">面谈</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="followupContent">跟进内容</label>
                        <textarea id="followupContent" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="followupNext">下次跟进提醒</label>
                        <input type="datetime-local" id="followupNext">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelFollowupBtn">取消</button>
                <button class="btn btn-primary" id="saveFollowupBtn">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let currentModule = 'customer-module';
        let customers = [];

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 检查登录状态
                checkLoginStatus();
                // 加载用户信息
                loadUserInfo();
                // 加载客户列表
                loadCustomers();
                // 绑定事件
                bindEvents();
            } catch (error) {
                console.error('页面初始化错误:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });

        // 检查登录状态
        function checkLoginStatus() {
            try {
                const userInfo = localStorage.getItem('userInfo');
                if (!userInfo) {
                    // 未登录，跳转到登录页
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('检查登录状态错误:', error);
                // 出错时跳转到登录页
                window.location.href = 'login.html';
            }
        }

        // 加载用户信息
        function loadUserInfo() {
            const userInfoStr = localStorage.getItem('userInfo');
            if (userInfoStr) {
                try {
                    const userInfo = JSON.parse(userInfoStr);
                    if (userInfo) {
                        document.getElementById('userNickname').textContent = userInfo.nickname || '未知用户';
                        
                        // 加载个人信息模块
                        document.getElementById('userUsername').value = userInfo.username || '';
                        document.getElementById('userNicknameInput').value = userInfo.nickname || '';
                        document.getElementById('userRole').value = userInfo.role || '';
                    }
                } catch (error) {
                    console.error('解析用户信息失败:', error);
                }
            }
        }

        // 加载客户列表
        function loadCustomers(page = 1) {
            try {
                currentPage = page;
                
                const name = document.getElementById('filterName').value;
                const phone = document.getElementById('filterPhone').value;
                const source = document.getElementById('filterSource').value;
                
                console.log('加载客户列表:', { page, name, phone, source });
                
                fetch(`http://localhost:8080/api/customers?page=${page}&limit=10&name=${name}&phone=${phone}&source=${source}`)
                    .then(response => {
                        console.log('响应状态:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('响应数据:', data);
                        if (data.code === 200) {
                            renderCustomerTable(data.data);
                            renderCustomerPagination(data.page, data.total, data.limit);
                            // 存储客户数据用于跟进记录选择
                            customers = data.data;
                            loadCustomerOptions();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('加载客户失败:', error);
                        alert('加载客户失败，请检查网络连接');
                    });
            } catch (error) {
                console.error('loadCustomers错误:', error);
                alert('加载客户列表失败: ' + error.message);
            }
        }

        // 渲染客户表格
        function renderCustomerTable(data) {
            const tbody = document.getElementById('customerTable').querySelector('tbody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暂无客户数据</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach(customer => {
                html += `
                    <tr>
                        <td>${customer.id}</td>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.company || '-'}</td>
                        <td>${customer.position || '-'}</td>
                        <td>${customer.source || '-'}</td>
                        <td>${customer.created_at}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editCustomer(${customer.id})">编辑</button>
                            <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})">删除</button>
                            <button class="btn btn-success" onclick="viewFollowups(${customer.id})">跟进记录</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // 渲染客户分页
        function renderCustomerPagination(page, total, limit) {
            const pagination = document.getElementById('customerPagination');
            const totalPages = Math.ceil(total / limit);
            
            let html = '';
            if (totalPages > 1) {
                // 上一页
                html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" onclick="loadCustomers(${page - 1})" ${page === 1 ? 'style="cursor: not-allowed;"' : ''}>上一页</a>
                </li>`;
                
                // 页码
                for (let i = 1; i <= totalPages; i++) {
                    html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" onclick="loadCustomers(${i})">${i}</a>
                    </li>`;
                }
                
                // 下一页
                html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" onclick="loadCustomers(${page + 1})" ${page === totalPages ? 'style="cursor: not-allowed;"' : ''}>下一页</a>
                </li>`;
            }
            
            pagination.innerHTML = html;
        }

        // 加载客户选项（用于跟进记录选择）
        function loadCustomerOptions() {
            const customerSelects = [
                document.getElementById('filterCustomer'),
                document.getElementById('followupCustomer')
            ];
            
            customerSelects.forEach(select => {
                if (select) {
                    let html = select.id === 'filterCustomer' ? '<option value="">全部客户</option>' : '<option value="">请选择客户</option>';
                    customers.forEach(customer => {
                        html += `<option value="${customer.id}">${customer.name} (${customer.phone})</option>`;
                    });
                    select.innerHTML = html;
                }
            });
        }

        // 加载跟进记录
        function loadFollowups(page = 1) {
            const customerId = document.getElementById('filterCustomer').value;
            
            fetch(`http://localhost:8080/api/followups?page=${page}&limit=10&customer_id=${customerId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderFollowupTable(data.data);
                        renderFollowupPagination(data.page, data.total, data.limit);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('加载跟进记录失败:', error);
                    alert('加载跟进记录失败，请检查网络连接');
                });
        }

        // 渲染跟进记录表格
        function renderFollowupTable(data) {
            const tbody = document.getElementById('followupTable').querySelector('tbody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">暂无跟进记录</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach(followup => {
                // 查找客户名称
                const customer = customers.find(c => c.id === followup.customer_id);
                const customerName = customer ? customer.name : '未知客户';
                
                html += `
                    <tr>
                        <td>${followup.id}</td>
                        <td>${customerName}</td>
                        <td>${followup.follow_time}</td>
                        <td>${followup.follow_method}</td>
                        <td>${followup.content.substring(0, 50)}${followup.content.length > 50 ? '...' : ''}</td>
                        <td>${followup.next_follow_reminder || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteFollowup(${followup.id})">删除</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // 渲染跟进记录分页
        function renderFollowupPagination(page, total, limit) {
            const pagination = document.getElementById('followupPagination');
            const totalPages = Math.ceil(total / limit);
            
            let html = '';
            if (totalPages > 1) {
                // 上一页
                html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" onclick="loadFollowups(${page - 1})" ${page === 1 ? 'style="cursor: not-allowed;"' : ''}>上一页</a>
                </li>`;
                
                // 页码
                for (let i = 1; i <= totalPages; i++) {
                    html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" onclick="loadFollowups(${i})">${i}</a>
                    </li>`;
                }
                
                // 下一页
                html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" onclick="loadFollowups(${page + 1})" ${page === totalPages ? 'style="cursor: not-allowed;"' : ''}>下一页</a>
                </li>`;
            }
            
            pagination.innerHTML = html;
        }

        // 绑定事件
        function bindEvents() {
            // 菜单切换
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const target = this.dataset.target;
                    
                    // 切换菜单激活状态
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 切换模块显示
                    document.querySelectorAll('.module-content').forEach(module => {
                        module.classList.add('hidden');
                    });
                    document.getElementById(target).classList.remove('hidden');
                    
                    currentModule = target;
                    
                    // 加载对应模块数据
                    if (target === 'followup-module') {
                        loadFollowups();
                    } else if (target === 'statistics-module') {
                        loadStatistics();
                    }
                });
            });

            // 刷新统计数据
            document.getElementById('refreshStatisticsBtn').addEventListener('click', function() {
                loadStatistics();
            });

            // 统计天数变化
            document.getElementById('statisticsDays').addEventListener('change', function() {
                loadStatistics();
            });

            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', function() {
                fetch('http://localhost:8080/api/logout', {
                method: 'POST'
            })
                .then(() => {
                    // 清除本地存储
                    localStorage.removeItem('userInfo');
                    // 跳转到登录页
                    window.location.href = 'login.html';
                });
            });

            // 添加客户按钮
            document.getElementById('addCustomerBtn').addEventListener('click', function() {
                document.getElementById('customerModalTitle').textContent = '添加客户';
                document.getElementById('customerForm').reset();
                document.getElementById('customerId').value = '';
                document.getElementById('customerModal').classList.remove('hidden');
            });

            // 关闭客户模态框
            document.getElementById('closeCustomerModal').addEventListener('click', function() {
                document.getElementById('customerModal').classList.add('hidden');
            });
            document.getElementById('cancelCustomerBtn').addEventListener('click', function() {
                document.getElementById('customerModal').classList.add('hidden');
            });

            // 保存客户
            document.getElementById('saveCustomerBtn').addEventListener('click', function() {
                const id = document.getElementById('customerId').value;
                const name = document.getElementById('customerName').value;
                const phone = document.getElementById('customerPhone').value;
                const email = document.getElementById('customerEmail').value;
                const company = document.getElementById('customerCompany').value;
                const position = document.getElementById('customerPosition').value;
                const source = document.getElementById('customerSource').value;
                const notes = document.getElementById('customerNotes').value;
                
                // 表单验证
                if (!name || !phone) {
                    alert('姓名和手机号不能为空');
                    return;
                }
                
                const url = id ? `http://localhost:8080/api/customers/${id}` : 'http://localhost:8080/api/customers';
                const method = id ? 'PUT' : 'POST';
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, phone, email, company, position, source, notes })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('保存成功');
                        document.getElementById('customerModal').classList.add('hidden');
                        loadCustomers();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('保存客户失败:', error);
                    alert('保存客户失败，请检查网络连接');
                });
            });

            // 添加跟进记录按钮
            document.getElementById('addFollowupBtn').addEventListener('click', function() {
                document.getElementById('followupForm').reset();
                document.getElementById('followupModal').classList.remove('hidden');
            });

            // 关闭跟进记录模态框
            document.getElementById('closeFollowupModal').addEventListener('click', function() {
                document.getElementById('followupModal').classList.add('hidden');
            });
            document.getElementById('cancelFollowupBtn').addEventListener('click', function() {
                document.getElementById('followupModal').classList.add('hidden');
            });

            // 保存跟进记录
            document.getElementById('saveFollowupBtn').addEventListener('click', function() {
                const customerId = document.getElementById('followupCustomer').value;
                const followTime = document.getElementById('followupTime').value;
                const followMethod = document.getElementById('followupMethod').value;
                const content = document.getElementById('followupContent').value;
                const nextFollowReminder = document.getElementById('followupNext').value;
                
                // 表单验证
                if (!customerId || !followTime || !followMethod || !content) {
                    alert('客户、跟进时间、跟进方式和内容不能为空');
                    return;
                }
                
                fetch('http://localhost:8080/api/followups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        customer_id: customerId, 
                        follow_time: followTime, 
                        follow_method: followMethod, 
                        content: content, 
                        next_follow_reminder: nextFollowReminder 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('保存成功');
                        document.getElementById('followupModal').classList.add('hidden');
                        loadFollowups();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('保存跟进记录失败:', error);
                    alert('保存跟进记录失败，请检查网络连接');
                });
            });

            // 客户查询
            document.getElementById('searchCustomerBtn').addEventListener('click', function() {
                loadCustomers(1);
            });

            // 导出客户列表为Excel
            document.getElementById('exportCustomerBtn').addEventListener('click', function() {
                const name = document.getElementById('filterName').value;
                const phone = document.getElementById('filterPhone').value;
                const source = document.getElementById('filterSource').value;
                
                // 构建导出URL
                let url = `http://localhost:8080/api/customers/export?`;
                if (name) url += `name=${encodeURIComponent(name)}&`;
                if (phone) url += `phone=${encodeURIComponent(phone)}&`;
                if (source) url += `source=${encodeURIComponent(source)}&`;
                
                // 移除末尾的&符号
                url = url.replace(/&$/, '');
                
                // 创建隐藏的a标签并点击下载
                const a = document.createElement('a');
                a.href = url;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            // 跟进记录查询
            document.getElementById('searchFollowupBtn').addEventListener('click', function() {
                loadFollowups(1);
            });

            // 个人信息保存
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nickname = document.getElementById('userNicknameInput').value;
                const password = document.getElementById('userPassword').value;
                
                fetch('http://localhost:8080/api/user/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nickname, password })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('保存成功');
                        // 更新本地存储的用户信息
                        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
                        userInfo.nickname = nickname;
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                        // 更新页面显示
                        document.getElementById('userNickname').textContent = nickname;
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('保存个人信息失败:', error);
                    alert('保存个人信息失败，请检查网络连接');
                });
            });
        }

        // 编辑客户
        function editCustomer(id) {
            fetch(`http://localhost:8080/api/customers/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const customer = data.data;
                        document.getElementById('customerModalTitle').textContent = '编辑客户';
                        document.getElementById('customerId').value = customer.id;
                        document.getElementById('customerName').value = customer.name;
                        document.getElementById('customerPhone').value = customer.phone;
                        document.getElementById('customerEmail').value = customer.email || '';
                        document.getElementById('customerCompany').value = customer.company || '';
                        document.getElementById('customerPosition').value = customer.position || '';
                        document.getElementById('customerSource').value = customer.source || '网络';
                        document.getElementById('customerNotes').value = customer.notes || '';
                        document.getElementById('customerModal').classList.remove('hidden');
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('获取客户详情失败:', error);
                    alert('获取客户详情失败，请检查网络连接');
                });
        }

        // 删除客户
        function deleteCustomer(id) {
            if (confirm('确定要删除这个客户吗？删除后相关的跟进记录也会被删除')) {
                fetch(`http://localhost:8080/api/customers/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('删除成功');
                        loadCustomers();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('删除客户失败:', error);
                    alert('删除客户失败，请检查网络连接');
                });
            }
        }

        // 查看客户跟进记录
        function viewFollowups(customerId) {
            // 切换到跟进记录模块
            document.querySelectorAll('.menu-item').forEach(menuItem => {
                menuItem.classList.remove('active');
            });
            document.querySelector('[data-target="followup-module"]').classList.add('active');
            
            document.querySelectorAll('.module-content').forEach(module => {
                module.classList.add('hidden');
            });
            document.getElementById('followup-module').classList.remove('hidden');
            
            // 设置客户筛选
            document.getElementById('filterCustomer').value = customerId;
            // 加载跟进记录
            loadFollowups();
        }

        // 删除跟进记录
        function deleteFollowup(id) {
            if (confirm('确定要删除这条跟进记录吗？')) {
                fetch(`http://localhost:8080/api/followups/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('删除成功');
                        loadFollowups();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('删除跟进记录失败:', error);
                    alert('删除跟进记录失败，请检查网络连接');
                });
            }
        }

        // 加载统计数据
        function loadStatistics() {
            const days = document.getElementById('statisticsDays').value;
            
            // 加载客户来源分布统计
            fetch(`http://localhost:8080/api/statistics/customer/source`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderCustomerSourceChart(data.data);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('获取客户来源分布统计失败:', error);
                    alert('获取客户来源分布统计失败，请检查网络连接');
                });

            // 加载跟进方式分布统计
            fetch(`http://localhost:8080/api/statistics/followup/method`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderFollowupMethodChart(data.data);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('获取跟进方式分布统计失败:', error);
                    alert('获取跟进方式分布统计失败，请检查网络连接');
                });

            // 加载客户数量统计
            fetch(`http://localhost:8080/api/statistics/customer/count?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderCustomerCountChart(data.data);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('获取客户数量统计失败:', error);
                    alert('获取客户数量统计失败，请检查网络连接');
                });

            // 加载跟进记录数量统计
            fetch(`http://localhost:8080/api/statistics/followup/count?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderFollowupCountChart(data.data);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('获取跟进记录数量统计失败:', error);
                    alert('获取跟进记录数量统计失败，请检查网络连接');
                });
        }

        // 渲染客户来源分布图表
        function renderCustomerSourceChart(data) {
            const chart = echarts.init(document.getElementById('customerSourceChart'));
            const sources = Object.keys(data);
            const counts = Object.values(data);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: sources
                },
                series: [
                    {
                        name: '客户来源',
                        type: 'pie',
                        radius: '50%',
                        data: sources.map((source, index) => ({
                            value: counts[index],
                            name: source
                        })),
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 窗口大小变化时，重新调整图表大小
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // 渲染跟进方式分布图表
        function renderFollowupMethodChart(data) {
            const chart = echarts.init(document.getElementById('followupMethodChart'));
            const methods = Object.keys(data);
            const counts = Object.values(data);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: methods
                },
                series: [
                    {
                        name: '跟进方式',
                        type: 'pie',
                        radius: '50%',
                        data: methods.map((method, index) => ({
                            value: counts[index],
                            name: method
                        })),
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 窗口大小变化时，重新调整图表大小
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // 渲染客户数量趋势图表
        function renderCustomerCountChart(data) {
            const chart = echarts.init(document.getElementById('customerCountChart'));
            const dates = Object.keys(data);
            const counts = Object.values(data);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b}<br/>客户数量: {c}'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    minInterval: 1
                },
                series: [
                    {
                        name: '客户数量',
                        type: 'line',
                        stack: 'Total',
                        data: counts,
                        areaStyle: {
                            opacity: 0.3
                        },
                        emphasis: {
                            focus: 'series'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 窗口大小变化时，重新调整图表大小
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // 渲染跟进记录数量趋势图表
        function renderFollowupCountChart(data) {
            const chart = echarts.init(document.getElementById('followupCountChart'));
            const dates = Object.keys(data);
            const counts = Object.values(data);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b}<br/>跟进记录: {c}'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    minInterval: 1
                },
                series: [
                    {
                        name: '跟进记录',
                        type: 'line',
                        stack: 'Total',
                        data: counts,
                        areaStyle: {
                            opacity: 0.3
                        },
                        emphasis: {
                            focus: 'series'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 窗口大小变化时，重新调整图表大小
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
    </script>
</body>
</html>
